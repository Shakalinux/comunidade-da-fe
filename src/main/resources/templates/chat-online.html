<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversar com - Comunidade da Fé</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>


    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

    <style>
        :root {
            --gold: #d4a017;
            --gold-dark: #b8860b;
            --brown: #4e342e;
            --cream: #fff8e1;
            --light: #fffaf3;
            --glass: rgba(255, 255, 255, 0.15);
            --shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            --at: #c19a6b;
            --nt: #5c6bc0;
        }

        * { scroll-behavior: smooth; }

        body {
            background: linear-gradient(135deg, #fdf6e3 0%, #ffe8c2 100%);
            font-family: 'Nunito', sans-serif;
            color: #3e2723;
            min-height: 100vh;
            background-attachment: fixed;
            padding-top: 90px;
        }

        header {
            backdrop-filter: blur(16px);
            background: rgba(78, 52, 46, 0.92);
            border-bottom: 1px solid rgba(212, 160, 23, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .offcanvas {
            background: linear-gradient(180deg, #3e2723 0%, #2c1a0f 100%);
            width: 290px !important;
            border-right: 3px solid var(--gold);
        }
        .offcanvas a {
            border-radius: 16px;
            margin: 10px 15px;
            padding: 16px 20px !important;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            color: white;
            text-decoration: none;
        }
        .offcanvas a::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,215,0,0.2), transparent);
            transition: 0.8s;
        }
        .offcanvas a:hover::before { left: 100%; }
        .offcanvas a:hover {
            background: var(--gold);
            color: #2c1a0f !important;
            transform: translateX(12px) scale(1.03);
            box-shadow: 0 8px 25px rgba(212,160,23,0.4);
        }

        .verse-floating {
            position: fixed;
            top: 100px;
            right: 20px;
            width: 320px;
            background: rgba(255, 250, 243, 0.95);
            backdrop-filter: blur(12px);
            border-left: 6px solid var(--gold);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            z-index: 999;
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @media (max-width: 768px) {
            .verse-floating {
                position: relative;
                top: auto;
                right: auto;
                width: 100%;
                max-width: 100%;
                animation: none;
                margin: 1rem auto 2rem;
                z-index: 10;
            }
        }

        .section-title {
            font-family: 'Cinzel', serif;
            color: var(--brown);
            font-size: 2.2rem;
            text-align: center;
            margin: 3rem 0 2rem;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: var(--gold);
            border-radius: 2px;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: all 0.4s ease;
            border: 1px solid rgba(212,160,23,0.2);
        }
        .user-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(212,160,23,0.3);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border: 3px solid var(--gold);
        }

        .btn-chat {
            background: linear-gradient(45deg, var(--gold), #ffd54f);
            color: #3e2723;
            border: none;
            border-radius: 50px;
            padding: 0.6rem 1.8rem;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(212,160,23,0.4);
            transition: all 0.4s ease;
            font-size: 0.9rem;
            /* Flex para alinhar botão e badge */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .btn-chat:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(212,160,23,0.6);
            color: #3e2723;
        }
        /* Estilo para o badge no botão */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            padding: 0.45em 0.75em;
            font-size: 0.75rem;
        }

        .table-responsive {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
        }
    </style>
</head>
<body>

<div class="container-fluid p-0">


    <header class="d-flex justify-content-between align-items-center py-3 fixed-top px-4">
        <button class="btn text-white fs-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menu">
            <span class="material-symbols-rounded">menu</span>
        </button>
        <a th:href="@{/profile}" class="header-avatar">
            <img class="rounded-circle shadow-lg"
                 th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
                 style="width: 52px; height: 52px; object-fit: cover; border: 4px solid white;"
                 alt="Perfil"
                 onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';">
        </a>
    </header>


    <div class="offcanvas offcanvas-start text-white" tabindex="-1" id="menu">
        <div class="offcanvas-header justify-content-center border-bottom border-warning border-3">
            <h5 class="fw-bold" style="font-family: 'Cinzel', serif; color: var(--gold);">Caminho da Fé</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body pt-4">
            <a th:href="@{/biblia/inicio}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">home</span> Início
            </a>
            <a th:href="@{/estudos/biblicos}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">auto_stories</span> Estudos Bíblicos
            </a>
            <a th:href="@{/estudos/salvos}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">bookmark</span> Estudos Salvos
            </a>
            <a th:href="@{/favorites}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">favorite</span> Favoritos
            </a>
            <a th:href="@{/biblia/biblioteca}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">library_books</span> Biblioteca da Fé
            </a>
            <a th:href="@{/comunidade/chat-online}" class="d-block text-white text-decoration-none active">
                <span class="material-symbols-rounded">chat</span> Conversas
            </a>
            <a th:href="@{/profile}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">person</span> Meu Perfil
                <span th:if="${unreadMessagesCount != null and unreadMessagesCount > 0}"
                      class="badge text-bg-danger rounded-pill ms-2"
                      th:text="${unreadMessagesCount}">
                </span>
            </a>
            <hr class="border-secondary">
            <a href="#" class="d-block text-danger text-decoration-none" onclick="document.getElementById('logoutForm').submit()">
                <span class="material-symbols-rounded">logout</span> Sair
            </a>
        </div>
    </div>

    <div class="verse-floating shadow-lg" id="cardVersiculoDia" style="display: none;">
        <p id="textoVersiculo" class="mb-2 fst-italic fw-bold" style="color: var(--brown);"></p>
        <small id="referenciaVersiculo" style="color: var(--gold);"></small>
    </div>


    <div class="container mt-5" data-aos="fade-up">
        <h2 class="section-title">Escolha alguém para conversar</h2>

        <div class="table-responsive" data-aos="fade-up" data-aos-delay="100">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light" style="background: rgba(212, 160, 23, 0.1);">
                <tr>
                    <th class="ps-4">Usuário</th>
                    <th class="text-center">Ação</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="u : ${users}" class="user-card" th:attr="data-username=${u.username}">
                    <td class="ps-4 d-flex align-items-center">
                        <img th:src="'data:image/jpeg;base64,' + ${u.profile.avatar64}"
                             class="rounded-circle me-3 user-avatar"
                             alt="Avatar">
                        <div>
                            <strong th:text="${u.username}">Usuário</strong>
                            <small class="text-muted d-block mb-0" th:text="${u.profile.ministerio} ?: 'Membro da Comunidade'"></small>

                            <small class="d-flex align-items-center mt-1 online-status">
                                <span class="material-symbols-rounded"
                                      th:style="${onlineUsers.contains(u.username)} ? 'color: #4caf50; font-size: 0.8rem; margin-right: 3px;' : 'color: #999; font-size: 0.8rem; margin-right: 3px;'">
                                    circle
                                </span>
                                <span th:if="${onlineUsers.contains(u.username)}" style="color: #4caf50; font-weight: 600; font-size: 0.8rem;">
                                    Online
                                </span>
                                <span th:unless="${onlineUsers.contains(u.username)}" style="color: #999; font-size: 0.8rem;">
                                    Offline
                                </span>
                            </small>
                        </div>
                    </td>
                    <td class="text-center">
                        <a th:href="@{'/comunidade/chat/privado/' + ${u.username}}"
                           class="btn btn-chat">
                            <span class="material-symbols-rounded me-1" style="font-size: 1.1rem;">chat_bubble</span>
                            Conversar

                            <span th:if="${unreadCounts != null and unreadCounts.get(u.username) > 0}"
                                  class="badge text-bg-danger rounded-pill notification-badge"
                                  th:text="${unreadCounts.get(u.username)}">
                                0
                            </span>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>


            <div th:if="${#lists.isEmpty(users)}" class="text-center py-5">
                <p class="text-muted fs-5">Nenhum usuário disponível para conversa no momento.</p>
            </div>
        </div>
    </div>


    <form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    AOS.init({ duration: 800, once: true });


    var loggedInUsername = /*[[${#authentication.name}]]*/ 'default_user';
    var stompClient = null;


    document.addEventListener("DOMContentLoaded", function() {
        const verse = {
            texto: "Porque Deus amou o mundo de tal maneira que deu o seu Filho unigênito...",
            ref: "João 3:16"
        };
        if (verse.texto) {
            document.getElementById("cardVersiculoDia").style.display = "block";
            document.getElementById("textoVersiculo").textContent = verse.texto;
            document.getElementById("referenciaVersiculo").textContent = verse.ref;
        }
    });

    // --- Lógica WebSocket para Atualização em Tempo Real ---

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        console.log('Conectado ao WebSocket para atualização de status e notificações.');


        stompClient.subscribe('/topic/user.status', onStatusReceived);

        stompClient.subscribe('/user/queue/notifications', onNotificationReceived);
    }

    function onError(error) {
        console.error('Erro na conexão WebSocket:', error);
    }

    function onStatusReceived(payload) {
        var statusChange = JSON.parse(payload.body);
        var username = statusChange.username;
        var status = statusChange.status;

        var statusContainer = document.querySelector(`tr[data-username="${username}"] .online-status`);

        if (statusContainer) {
            if (status === "ONLINE") {
                statusContainer.innerHTML =
                    '<span class="material-symbols-rounded" style="color: #4caf50; font-size: 0.8rem; margin-right: 3px;">circle</span>' +
                    '<span style="color: #4caf50; font-weight: 600; font-size: 0.8rem;">Online</span>';
            } else {
                statusContainer.innerHTML =
                    '<span class="material-symbols-rounded" style="color: #999; font-size: 0.8rem; margin-right: 3px;">circle</span>' +
                    '<span style="color: #999; font-size: 0.8rem;">Offline</span>';
            }
        }
    }


    function onNotificationReceived(payload) {

        var notification = JSON.parse(payload.body);
        var senderUsername = notification.sender;
        var count = notification.count;

        var userRow = document.querySelector(`tr[data-username="${senderUsername}"]`);

        if (userRow) {
            var btnChat = userRow.querySelector('.btn-chat');
            var badge = userRow.querySelector('.notification-badge');

            if (count > 0) {

                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'badge text-bg-danger rounded-pill notification-badge';
                    btnChat.appendChild(badge);
                }

                badge.textContent = count;

            } else if (badge) {

                badge.remove();
            }
        }

        updateGlobalNotification();
    }

    function updateGlobalNotification() {
        var globalBadge = document.querySelector('.offcanvas a[href*="/profile"] .badge');
        if (globalBadge) {
        }
    }

    connect();
</script>

</body>
</html>