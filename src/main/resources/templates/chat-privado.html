<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Chat com ' + ${receiver}">Chat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/chat-privado.css}">
</head>
<body>

<div class="container-fluid p-0">

    <header class="d-flex justify-content-between align-items-center py-3 fixed-top px-4">
        <button class="btn text-white fs-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menu">
            <span class="material-symbols-rounded">menu</span>
        </button>

        <a th:href="@{/profile}" class="header-avatar">
            <img class="rounded-circle shadow-lg"
                 th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
                 style="width: 52px; height: 52px; object-fit: cover; border: 4px solid white;"
                 alt="Perfil"
                 onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';">
        </a>
    </header>

    <div class="offcanvas offcanvas-start text-white" tabindex="-1" id="menu">
        <div class="offcanvas-header justify-content-center border-bottom border-warning border-3">
            <h5 class="fw-bold" style="font-family: 'Cinzel', serif; color: var(--gold);">Caminho da Fé</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body pt-4">
            <a th:href="@{/biblia/inicio}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">home</span> Início
            </a>
            <a th:href="@{/estudos/biblicos}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">auto_stories</span> Estudos Bíblicos
            </a>
            <a th:href="@{/estudos/salvos}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">bookmark</span> Estudos Salvos
            </a>
            <a th:href="@{/favorites}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">favorite</span> Favoritos
            </a>
            <a th:href="@{/biblia/biblioteca}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">library_books</span> Biblioteca da Fé
            </a>
            <a th:href="@{/comunidade/chat-online}" class="d-block text-white text-decoration-none active">
                <span class="material-symbols-rounded">chat</span> Conversas
            </a>
            <a th:href="@{/profile}" class="d-block text-white text-decoration-none">
                <span class="material-symbols-rounded">person</span> Meu Perfil
                <span th:if="${unreadMessagesCount != null and unreadMessagesCount > 0}"
                      class="badge text-bg-danger rounded-pill ms-2"
                      th:text="${unreadMessagesCount}">
                </span>
            </a>
            <hr class="border-secondary">
            <a href="#" class="d-block text-danger text-decoration-none" onclick="document.getElementById('logoutForm').submit()">
                <span class="material-symbols-rounded">logout</span> Sair
            </a>
        </div>
    </div>



    <div class="container mt-5" data-aos="fade-up">
        <div class="chat-container">

            <div class="chat-header">
                <div class="d-flex align-items-center gap-3">
                    <img class="rounded-circle border border-4 border-warning shadow-lg"
                         th:src="'data:image/jpeg;base64,' + ${destinatario.profile.avatar64}"
                         style="width: 50px; height: 50px; object-fit: cover;"
                         alt="Perfil"
                         onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';">

                    <div class="d-flex flex-column">
                        <div class="fw-bold" style="font-family: 'Cinzel', serif; color: #3e2723; font-size: 1.2rem;"
                             th:text="${receiver}">Usuário</div>

                        <small id="statusIndicator">
                            <span class="material-symbols-rounded"
                                  th:style="${onlineUsers.contains(receiver)} ? 'color: #4caf50; font-size: 1rem;' : 'color: #999; font-size: 1rem;'">
                                circle
                            </span>
                            <span th:if="${onlineUsers.contains(receiver)}" style="color: #4caf50; font-weight: 600;">
                                Online
                            </span>
                            <span th:unless="${onlineUsers.contains(receiver)}" style="color: #999;">
                                Offline
                            </span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="chat-messages" id="messagesContainer">

                <div th:each="msg : ${messages}"
                     th:class="${msg.sender == sender} ? 'message sent' : 'message received'"
                     th:attr="data-message-id=${msg.id}">

                    <div th:text="${msg.content}">Texto</div>

                    <div class="message-time">
                        <span th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">00:00</span>

                        <span th:if="${msg.sender == sender}" class="read-status" th:attr="data-message-id=${msg.id}">
                           <span th:if="${msg.readflag}"
                                 class="material-symbols-rounded check-icon"
                                 style="font-size: 0.8rem; color: #4CAF50;">done_all</span>
                           <span th:unless="${msg.readflag}"
                                 class="material-symbols-rounded check-icon"
                                 style="font-size: 0.8rem; color: #999;">done</span>
                        </span>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(messages)}" class="no-messages">
                    <p class="mb-2">Que a paz do Senhor esteja contigo!</p>
                    <small>Inicie a conversa com uma saudação.</small>
                </div>
            </div>

            <form class="chat-input" id="messageForm">
                <input type="text" name="content" id="messageInput"
                       placeholder="Digite sua mensagem..."
                       required autocomplete="off"/>

                <button type="submit" class="btn-send">
                    <span class="material-symbols-rounded">send</span>
                </button>

            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    var sender = [[${sender}]];
    var receiver = [[${receiver}]];
    var stompClient = null;

    var typingTimeout;
    var isTyping = false;

    var messagesContainer = document.getElementById('messagesContainer');
    var messageInput = document.getElementById('messageInput');
    var statusIndicator = document.getElementById('statusIndicator');

    // Variável para rastrear o status ONLINE/OFFLINE em tempo real (corrigindo o bug)
    var currentOnlineStatus = [[${onlineUsers}]].includes(receiver) ? "ONLINE" : "OFFLINE";

    AOS.init({duration: 800, once: true});

    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        stompClient.subscribe('/user/queue/messages', onMessageReceived);
        stompClient.subscribe('/topic/user.status', onStatusReceived);
        stompClient.subscribe('/user/queue/typing', onTypingReceived);
        stompClient.subscribe('/user/queue/read-status', onReadStatusReceived);

        sendReadStatus();
    }

    function onError(error) {
        console.error('Erro na conexão WebSocket:', error);
    }

    function sendTypingStatus(status) {
        if (stompClient) {
            var typingMessage = {
                sender: sender,
                receiver: receiver,
                typing: status
            };
            stompClient.send("/app/chat.typing", {}, JSON.stringify(typingMessage));
        }
    }

    function handleTyping() {
        if (!isTyping) {
            isTyping = true;
            sendTypingStatus(true);
        }

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            isTyping = false;
            sendTypingStatus(false);
        }, 3000);
    }

    // CORRIGIDO: onTypingReceived agora usa currentOnlineStatus
    function onTypingReceived(payload) {
        var typingStatus = JSON.parse(payload.body);

        if (typingStatus.sender === receiver) {
            if (typingStatus.typing) {
                statusIndicator.innerHTML = '<span style="color: #007bff; font-style: italic; font-weight: 600;">Digitando...</span>';
            } else {
                // Reverte para o status ONLINE/OFFLINE rastreado pelo onStatusReceived
                updateOnlineStatusDisplay(currentOnlineStatus);
            }
        }
    }

    function sendReadStatus() {
        if (stompClient) {
            var readMessage = {
                receiver: sender,
                sender: receiver,
            };
            stompClient.send("/app/chat.read", {}, JSON.stringify(readMessage));
        }
    }

    function onReadStatusReceived(payload) {
        var readStatus = JSON.parse(payload.body);

        if (readStatus.sender === receiver) {
            readStatus.readIds.forEach(msgId => {
                var statusSpan = document.querySelector(`.message-time .read-status[data-message-id="${msgId}"]`);

                if (statusSpan) {
                    statusSpan.innerHTML =
                        '<span class="material-symbols-rounded check-icon" ' +
                        'style="font-size: 0.8rem; color: #4CAF50;">done_all</span>';
                }
            });
        }
    }

    // CORRIGIDO: onStatusReceived atualiza currentOnlineStatus e chama updateOnlineStatusDisplay
    function onStatusReceived(payload) {
        var statusChange = JSON.parse(payload.body);
        var username = statusChange.username;
        var status = statusChange.status;

        if (username === receiver) {
            // 1. Atualiza o status em tempo real
            currentOnlineStatus = status;

            // 2. Apenas atualiza o display se o usuário não estiver digitando
            // Se estiver digitando, o status 'Digitando...' permanece.
            if (!isTyping) {
                updateOnlineStatusDisplay(currentOnlineStatus);
            }
        }
    }

    // SIMPLIFICADO: Esta função agora recebe o status real (string "ONLINE" ou "OFFLINE")
    function updateOnlineStatusDisplay(status) {
        if (statusIndicator) {
            if (status === "ONLINE") {
                statusIndicator.innerHTML =
                    '<span class="material-symbols-rounded" style="color: #4caf50; font-size: 1rem;">circle</span>' +
                    '<span style="color: #4caf50; font-weight: 600;">Online</span>';
            } else {
                statusIndicator.innerHTML =
                    '<span class="material-symbols-rounded" style="color: #999; font-size: 1rem;">circle</span>' +
                    '<span style="color: #999;">Offline</span>';
            }
        }
    }


    function sendMessage(event) {
        event.preventDefault();
        var messageContent = messageInput.value.trim();

        if (messageContent && stompClient) {
            var chatMessage = {
                sender: sender,
                receiver: receiver,
                content: messageContent,
            };

            stompClient.send("/app/send-message", {}, JSON.stringify(chatMessage));

            messageInput.value = '';

            clearTimeout(typingTimeout);
            sendTypingStatus(false);
            isTyping = false;
        }
    }

    function onMessageReceived(payload) {
        var message = JSON.parse(payload.body);

        var isRelevant = (message.sender === sender && message.receiver === receiver) ||
            (message.sender === receiver && message.receiver === sender);

        if (isRelevant) {
            appendMessageToChat(message);
            if (message.sender === receiver) {
                sendReadStatus();
            }
        }
    }

    function appendMessageToChat(message) {
        var container = document.getElementById('messagesContainer');
        var isSent = message.sender === sender;

        var messageDiv = document.createElement('div');
        messageDiv.className = isSent ? 'message sent' : 'message received';

        if (message.id) {
            messageDiv.setAttribute('data-message-id', message.id);
        }

        var contentDiv = document.createElement('div');
        contentDiv.textContent = message.content;
        messageDiv.appendChild(contentDiv);

        var timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        if(isSent){
            var messageId = message.id || 'temp-id';
            timeDiv.innerHTML +=
                '<span class="read-status" data-message-id="' + messageId + '">' +
                '<span class="material-symbols-rounded check-icon" style="font-size: 0.8rem; color: #999; margin-left: 3px;">done</span>' +
                '</span>';
        }

        messageDiv.appendChild(timeDiv);

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
    }

    connect();
    document.getElementById('messageForm').addEventListener('submit', sendMessage);
    messageInput.addEventListener('input', handleTyping);
</script>

</body>
</html>