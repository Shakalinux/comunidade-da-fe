<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudos Bíblicos - Caminho da Fé</title>


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">


    <link rel="stylesheet" th:href="@{/biblia/biblioteca.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">

    <style>
        body {
            background: #fff8e1;
            font-family: 'Merriweather', serif;
        }

        header{
            background-color: #4e342e !important;
        }

        .conteudo {
            margin-top: 80px;
        }

        .devocional-card {
            background: #fffaf2;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        h1, h5, .text-primary {
            color: #795548 !important;
        }

        .btn-outline-primary {
            border-color: #795548;
            color: #795548;
        }

        .btn-outline-primary:hover {
            background-color: #795548;
            color: #fff8e1;
        }

        .btn-primary {
            background-color: #ffb300;
            border: none;
            color: #4e342e;
        }

        .btn-primary:hover {
            background-color: #ffa000;
            color: #fff;
        }

        footer {
            background-color: #fff3cd;
            color: #5d4037;
        }

        pre {
            white-space: pre-wrap;
            text-align: justify;
        }
    </style>
</head>
<body>

<div class="container-fluid p-0">

    <header class="d-flex justify-content-between align-items-center py-3 text-white fixed-top px-3">
        <button class="btn text-white" type="button" data-bs-toggle="offcanvas" data-bs-target="#menu">
            <span class="material-symbols-outlined">menu</span>
        </button>
        <a th:href="@{/profile}">
            <img class="rounded-circle"
                 th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
                 style="width:35px;height:35px;border:2px solid #fff"
                 onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg';">
        </a>
    </header>


    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="menu" aria-labelledby="menuLabel">
        <div class="offcanvas-header text-center ">
            <h5 id="menuLabel " class="text-white">Caminho da Fé</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
        </div>
        <div class="offcanvas-body custom-offcanvas">
            <a th:href="@{/biblia/inicio}" class="d-block py-2 text-white text-decoration-none">
                <span class="material-symbols-outlined">home</span> <span class="text">Início</span>
            </a>
            <a th:href="@{/estudos/salvos}" class="d-block py-2 text-white text-decoration-none">
                <span class="material-symbols-outlined">book</span> <span class="text">Estudos Salvos</span>
            </a>
            <a th:href="@{/estudos/biblicos}" class="d-block py-2 text-white text-decoration-none">
                <span class="material-symbols-outlined">book_online</span> <span class="text">Estudos Bíblicos</span>
            </a>
            <a th:href="@{/favorites}" class="d-block py-2 text-white text-decoration-none">
                <span class="material-symbols-outlined">star</span> <span class="text">Versículos Favoritos</span>
            </a>
            <a th:href="@{/biblia/biblioteca}" class="d-block py-2 text-white text-decoration-none">
                <span class="material-symbols-outlined">bookmark</span> <span class="text">Biblioteca da Fé</span>
            </a>
            <a th:href="@{/profile}" class="d-block py-2 text-white text-decoration-none">
                <span class="material-symbols-outlined">person</span> <span class="text">Meu Perfil</span>
            </a>
            <a href="#" class="d-block py-2 text-white text-decoration-none" onclick="document.getElementById('logoutForm').submit()">
                <span class="material-symbols-outlined">logout</span> <span class="text">Sair</span>
            </a>

            <form id="logoutForm" th:action="@{/logout}" method="post" style="display: none;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>
        </div>
    </div>


    <div class="conteudo container mt-5 pt-4">
        <div class="devocional-card text-center">
            <h1 class="mb-4">Estudos Bíblicos</h1>

            <form id="formEstudo" class="mb-4">
                <div class="input-group w-75 mx-auto">
                    <input type="text" id="tema" name="tema" class="form-control"
                           placeholder="Digite um tema (ex: fé, esperança, amor)" required>
                    <button class="btn btn-primary" type="submit">Gerar Estudo</button>
                </div>
            </form>


            <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                <h5 class="w-100 text-secondary mb-2">Temas Sugeridos</h5>
                <button type="button"
                        th:each="t : ${temas}"
                        class="btn btn-outline-primary btn-sm tema-btn"
                        th:text="${#strings.capitalize(t)}"
                        th:attr="data-tema=${t}">
                </button>
            </div>

            <div id="resultado" class="alert alert-warning">
                Insira um tema e gere um estudo bíblico inspirado por Deus.
            </div>
        </div>
    </div>

    <footer class="text-center py-3 mt-4">
        <p>&copy; 2025 Caminho da Fé</p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".tema-btn").forEach(function (botao) {
            botao.addEventListener("click", function () {
                const tema = this.getAttribute("data-tema");
                document.getElementById("tema").value = tema;
                gerarEstudo();
            });
        });

        document.getElementById("formEstudo").addEventListener("submit", function (e) {
            e.preventDefault();
            gerarEstudo();
        });
    });

    function gerarEstudo() {
        const tema = document.getElementById("tema").value.trim();
        const resultado = document.getElementById("resultado");
        if (tema === "") return;

        resultado.innerHTML =
            "<div class='text-center'><div class='spinner-border text-warning'></div><p>Gerando estudo...</p></div>";

        const token = document.querySelector("meta[name='_csrf']").content;
        const header = document.querySelector("meta[name='_csrf_header']").content;

        fetch("/estudos/gerar", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                [header]: token
            },
            body: "tema=" + encodeURIComponent(tema)
        })
            .then(resp => resp.text())
            .then(text => {
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error("Resposta inválida do servidor:", text);
                    resultado.innerHTML =
                        "<div class='alert alert-danger'>Erro ao gerar estudo. Verifique o console.</div>";
                    return;
                }

                resultado.innerHTML =
                    "<h5 class='text-secondary'>Tema: " + data.tema + "</h5>" +
                    "<blockquote>“Medite e aplique estas palavras em seu coração.”</blockquote>" +
                    "<pre class='text-start'>" + data.mensagem + "</pre>" +
                    "<div class='mt-3'>" +
                    "<button id='btnFavoritar' class='btn btn-outline-primary'>" +
                    "<span class='material-symbols-outlined'>star</span> Favoritar</button>" +
                    "</div>";

                const btn = document.getElementById("btnFavoritar");
                btn.addEventListener("click", function () {
                    salvarEstudo(data.tema, data.mensagem);
                });
            })
            .catch(err => {
                console.error(err);
                resultado.innerHTML =
                    "<div class='alert alert-danger'>Erro ao gerar estudo.</div>";
            });
    }

    function salvarEstudo(tema, mensagem) {
        const token = document.querySelector("meta[name='_csrf']").content;
        const header = document.querySelector("meta[name='_csrf_header']").content;

        const params = new URLSearchParams();
        params.append("tema", tema);
        params.append("mensagem", mensagem);

        fetch("/estudos/salvar", {
            method: "POST",
            headers: {
                [header]: token
            },
            body: params
        })
            .then(resp => resp.text())
            .then(msg => {
                console.log("Resposta do servidor:", msg);
                alert(msg);
            })
            .catch(() => {
                alert("Erro de conexão ao salvar estudo.");
            });
    }
</script>

</body>
</html>
