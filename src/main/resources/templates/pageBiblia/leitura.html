<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${livro.nome} + ' ' + ${capitulo}"></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Georgia&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/biblia/leitura.css}">
</head>
<body>

<header class="d-flex justify-content-between align-items-center">
    <div>
        <a th:href="@{/biblia/biblioteca}" class="btn btn-outline-light btn-sm">
            <span class="material-symbols-outlined">arrow_back</span> Voltar
        </a>
    </div>
    <div class="text-center"><strong>Leitura Bíblica</strong></div>
    <div>
        <a th:href="@{/profile}" class="d-flex align-items-center text-decoration-none text-white">
            <img class="user-avatar"
                 th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
                 alt="Foto de Perfil"
                 onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';">
        </a>
    </div>
</header>

<div class="page">


    <div th:if="${sucesso}" id="alert-sucesso" class="alert alert-success mt-3 fade show" role="alert" th:text="${sucesso}"></div>
    <div th:if="${erro}" id="alert-erro" class="alert alert-danger mt-3 fade show" role="alert" th:text="${erro}"></div>

    <div class="top-controls d-flex justify-content-between align-items-center flex-wrap">

        <h2 class="h4 me-3 mb-2 mb-md-0" th:text="${livro.nome}"></h2>

        <form th:if="${totalCapitulos > 0}" th:action="@{'/biblia/leitura/' + ${livro.id}}" method="get" class="d-inline-flex me-3 mb-2 mb-md-0">
            <select name="capitulo" class="form-select w-auto" onchange="window.location.href = this.value">
                <option th:each="c : ${#numbers.sequence(1, totalCapitulos)}"
                        th:value="@{'/biblia/leitura/' + ${livro.id} + '/' + ${c} + '?versaoId=' + ${versaoId}}"
                        th:text="'Capítulo ' + ${c}"
                        th:selected="${c == capitulo}">
                </option>
            </select>
        </form>

        <form th:action="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capitulo}}" method="get" class="d-inline-flex mb-2 mb-md-0">
            <select name="versaoId" class="form-select w-auto" onchange="this.form.submit()">
                <option th:each="v : ${versoes}"
                        th:value="${v.id}"
                        th:text="${v.nome}"
                        th:selected="${v.id == versaoId}">
                </option>
            </select>
        </form>

    </div>

    <div class="page-column">

        <div class="versiculo-linha" th:each="v : ${versiculos}">
            <form th:action="@{/favorites/toggle-form}" method="post" class="d-inline versiculo-form">
                <input type="hidden" name="versiculoId" th:value="${v.id}">
                <input type="hidden" name="redirectUrl"
                       th:value="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capitulo} + '?versaoId=' + ${versaoId} + '&pagina=' + ${pagina}}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                <button type="submit"
                        class="favorito-btn"
                        th:title="${#lists.contains(favoritosIds, v.id)} ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                    <span class="material-symbols-outlined"
                          th:text="${#lists.contains(favoritosIds, v.id)} ? 'bookmark' : 'bookmark_add'"></span>
                </button>
            </form>

            <span class="verse-number" th:text="${v.numero}"></span>

            <span th:classappend="${#lists.contains(favoritosIds, v.id)} ? 'favorito-ativo' : 'favorito-inativo'"
                  class="versiculo-texto"
                  th:text="${v.texto}">
            </span>
        </div>

    </div>

    <div class="d-flex justify-content-between mt-3">
        <a th:if="${capituloAnterior != null}"
           th:href="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capituloAnterior} + '?versaoId=' + ${versaoId}}"
           class="btn btn-outline-dark">⬅ Capítulo anterior</a>

        <a th:if="${capituloProximo != null}"
           th:href="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capituloProximo} + '?versaoId=' + ${versaoId}}"
           class="btn btn-dark ms-auto">Próximo capítulo ➡</a>
    </div>
</div>

<footer class="text-center mt-4">
    <small>© 2025 Bíblia Online — Inspirando sua fé todos os dias.</small>
</footer>q
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const tempo = 5000;
        function mostrarMensagem(texto, tipo = "success") {
            const div = document.createElement("div");
            div.className = `alert alert-${tipo} mt-3 fade show`;
            div.role = "alert";
            div.textContent = texto;
            document.querySelector(".page").prepend(div);
            setTimeout(() => div.classList.remove("show"), tempo);
            setTimeout(() => div.remove(), tempo + 500);
        }

        document.querySelectorAll(".versiculo-form").forEach(form => {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const formData = new FormData(form);
                const csrfToken = form.querySelector('input[name="_csrf"]').value;
                const csrfHeader = form.querySelector('input[name="_csrf"]').getAttribute("name");

                try {
                    const response = await fetch(form.action, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            [csrfHeader]: csrfToken
                        },
                        body: formData
                    });

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const result = await response.json();

                    const icon = form.querySelector(".material-symbols-outlined");
                    const versiculo = form.parentElement.querySelector(".versiculo-texto");

                    if (result.success) {
                        if (result.favorited) {
                            icon.textContent = "bookmark";
                            versiculo.classList.add("favorito-ativo");
                            versiculo.classList.remove("favorito-inativo");
                        } else {
                            icon.textContent = "bookmark_add";
                            versiculo.classList.add("favorito-inativo");
                            versiculo.classList.remove("favorito-ativo");
                        }
                        mostrarMensagem(result.message, "success");
                    } else {
                        mostrarMensagem(result.error || "Erro ao salvar favorito.", "danger");
                    }
                } catch (err) {
                    console.error(err);
                    mostrarMensagem("Erro ao conectar com o servidor.", "danger");
                }
            });
        });
    });
</script>

</body>
</html>
