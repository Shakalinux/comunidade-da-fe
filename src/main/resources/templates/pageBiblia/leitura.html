<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${livro.nome} + ' ' + ${capitulo}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/biblia/leitura.css}">

    <style>

    </style>
</head>
<body>


<div id="particles-js"></div>

<header class="d-flex justify-content-between align-items-center">
    <a th:href="@{/biblia/biblioteca}" class="header-btn">
        <span class="material-symbols-rounded">arrow_back</span> Voltar
    </a>
    <div class="text-center fw-bold text-white" style="font-size: 1.3rem;">Leitura Bíblica</div>
    <a th:href="@{/profile}" class="header-avatar">
        <img class="rounded-circle shadow-lg"
             th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
             style="width: 52px; height: 52px; object-fit: cover; border: 4px solid white;"
             alt="Perfil"
             onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';">
    </a>
</header>

<div class="container">
    <div class="page shadow-lg" data-aos="fade-up">

        <!-- Mensagens -->
        <div th:if="${sucesso}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${sucesso}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${erro}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Controles -->
        <div class="text-center mb-4">
            <h1 class="chapter-title" th:text="${livro.nome + ' ' + capitulo}"></h1>
        </div>

        <div class="control-group d-flex justify-content-center align-items-center flex-wrap gap-3 mb-5">
            <form th:action="@{'/biblia/leitura/' + ${livro.id}}" method="get" class="d-inline-flex">
                <select name="capitulo" class="form-select" onchange="window.location.href = this.value">
                    <option th:each="c : ${#numbers.sequence(1, totalCapitulos)}"
                            th:value="@{'/biblia/leitura/' + ${livro.id} + '/' + ${c} + '?versaoId=' + ${versaoId}}"
                            th:text="'Capítulo ' + ${c}"
                            th:selected="${c == capitulo}">
                    </option>
                </select>
            </form>

            <form th:action="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capitulo}}" method="get" class="d-inline-flex">
                <select name="versaoId" class="form-select" onchange="this.form.submit()">
                    <option th:each="v : ${versoes}"
                            th:value="${v.id}"
                            th:text="${v.nome}"
                            th:selected="${v.id == versaoId}">
                    </option>
                </select>
            </form>
        </div>

        <!-- Versículos -->
        <div class="page-column">
            <div class="versiculo-linha" th:each="v : ${versiculos}">
                <form th:action="@{/favorites/toggle-form}" method="post" class="d-inline versiculo-form">
                    <input type="hidden" name="versiculoId" th:value="${v.id}">
                    <input type="hidden" name="redirectUrl"
                           th:value="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capitulo} + '?versaoId=' + ${versaoId}}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <button type="submit" class="favorito-btn"
                            th:classappend="${#lists.contains(favoritosIds, v.id)} ? 'active' : ''"
                            th:title="${#lists.contains(favoritosIds, v.id)} ? 'Remover' : 'Salvar'">
                        <span class="material-symbols-rounded"
                              th:text="${#lists.contains(favoritosIds, v.id)} ? 'bookmark' : 'bookmark_add'"></span>
                    </button>
                </form>

                <span class="verse-number" th:text="${v.numero}"></span>
                <span class="versiculo-texto"
                      th:classappend="${#lists.contains(favoritosIds, v.id)} ? 'favorito-ativo' : ''"
                      th:text="${v.texto}"></span>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-3">
            <a th:if="${capituloAnterior != null}"
               th:href="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capituloAnterior} + '?versaoId=' + ${versaoId}}"
               class="btn btn-outline-dark">⬅ Capítulo anterior</a>

            <a th:if="${capituloProximo != null}"
               th:href="@{'/biblia/leitura/' + ${livro.id} + '/' + ${capituloProximo} + '?versaoId=' + ${versaoId}}"
               class="btn btn-dark ms-auto">Próximo capítulo ➡</a>
        </div>
    </div>
</div>

<footer>
    <p>&copy; 2025 Bíblia Online — <em>“Lâmpada para os meus pés é tua palavra, e luz para o meu caminho.” (Salmo 119:105)</em></p>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

<script>
    AOS.init({ duration: 1000, once: true });

    // Partículas douradas
    particlesJS("particles-js", {
        "particles": {
            "number": { "value": 80 },
            "color": { "value": "#d4a017" },
            "shape": { "type": "circle" },
            "opacity": { "value": 0.5, "random": true },
            "size": { "value": 3, "random": true },
            "line_linked": { "enable": false },
            "move": { "enable": true, "speed": 1, "direction": "none", "random": true }
        },
        "interactivity": {
            "detect_on": "canvas",
            "events": { "onhover": { "enable": true, "mode": "repulse" } }
        }
    });

    // Seu JS de favoritos com explosão dourada
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".versiculo-form").forEach(form => {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = form.querySelector(".favorito-btn");
                const icon = btn.querySelector(".material-symbols-rounded");
                const versiculo = form.parentElement.querySelector(".versiculo-texto");

                // Explosão dourada
                const rect = btn.getBoundingClientRect();
                const spark = document.createElement("div");
                spark.style.position = "fixed";
                spark.style.left = rect.left + rect.width/2 + "px";
                spark.style.top = rect.top + rect.height/2 + "px";
                spark.style.width = "10px";
                spark.style.height = "10px";
                spark.style.background = "#d4a017";
                spark.style.borderRadius = "50%";
                spark.style.pointerEvents = "none";
                spark.style.zIndex = "9999";
                spark.style.boxShadow = "0 0 20px #d4a017";
                document.body.appendChild(spark);

                for (let i = 0; i < 12; i++) {
                    setTimeout(() => {
                        const p = document.createElement("div");
                        p.style.position = "fixed";
                        p.style.left = rect.left + rect.width/2 + "px";
                        p.style.top = rect.top + rect.height/2 + "px";
                        p.style.width = "6px";
                        p.style.height = "6px";
                        p.style.background = "#ffd700";
                        p.style.borderRadius = "50%";
                        p.style.transform = `rotate(${i*30}deg) translateY(-50px)`;
                        p.style.animation = "sparkle 1s ease-out forwards";
                        document.body.appendChild(p);
                        setTimeout(() => p.remove(), 1000);
                    }, i * 50);
                }

                try {
                    const formData = new FormData(form);
                    const response = await fetch(form.action, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRF-TOKEN": document.querySelector('input[name="_csrf"]').value
                        },
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.favorited) {
                            icon.textContent = "bookmark";
                            versiculo.classList.add("favorito-ativo");
                            btn.classList.add("active");
                        } else {
                            icon.textContent = "bookmark_add";
                            versiculo.classList.remove("favorito-ativo");
                            btn.classList.remove("active");
                        }
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        });
    });

    // Animação de brilho
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes sparkle {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
</script>

</body>
</html>