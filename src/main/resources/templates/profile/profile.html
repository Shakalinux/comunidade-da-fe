<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - Caminho da Fé</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>

<div id="particles-js"></div>

<header class="d-flex justify-content-between align-items-center py-3 fixed-top px-4">
    <button class="btn text-white fs-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#menu">
        <span class="material-symbols-rounded">menu</span>
    </button>
    <a th:href="@{/profile}" class="header-avatar">
        <img class="rounded-circle shadow-lg"
             th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
             style="width: 52px; height: 52px; object-fit: cover; border: 4px solid white;"
             alt="Perfil"
             onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';">
    </a>
</header>

<div class="offcanvas offcanvas-start text-white" tabindex="-1" id="menu">
    <div class="offcanvas-header justify-content-center border-bottom border-warning border-3">
        <h5 class="fw-bold" style="font-family: 'Cinzel', serif; color: var(--gold);">Caminho da Fé</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body pt-4">
        <a th:href="@{/biblia/inicio}" class="d-block text-white text-decoration-none">
            <span class="material-symbols-rounded">home</span> Início
        </a>
        <a th:href="@{/comunidade/feed}" class="d-block text-white text-decoration-none">
            <span class="material-symbols-rounded">Church</span> Comunidade
        </a>
        <a th:href="@{/estudos/salvos}" class="d-block text-white text-decoration-none">
            <span class="material-symbols-rounded">bookmark</span> Estudos Salvos
        </a>
        <a th:href="@{/favorites}" class="d-block text-white text-decoration-none">
            <span class="material-symbols-rounded">favorite</span> Favoritos
        </a>
        <a th:href="@{/biblia/biblioteca}" class="d-block text-white text-decoration-none">
            <span class="material-symbols-rounded">library_books</span> Biblioteca
        </a>
        <a th:href="@{/comunidade/chat-online}" class="d-block text-white text-decoration-none">
            <span class="material-symbols-rounded">chat</span> Conversas

            <span th:if="${unreadMessagesCount != null and unreadMessagesCount > 0}"
                  class="badge text-bg-danger rounded-pill ms-2"
                  th:text="${unreadMessagesCount}">
    </span>
        </a>

        <a th:href="@{/profile}" class="d-block text-white text-decoration-none active">
            <span class="material-symbols-rounded">person</span> Meu Perfil
        </a>
        <hr class="border-secondary">
        <a href="#" class="d-block text-danger text-decoration-none" onclick="document.getElementById('logoutForm').submit()">
            <span class="material-symbols-rounded">logout</span> Sair
        </a>
    </div>
</div>

<div class="container mt-5">

    <div class="profile-banner" id="bannerContainer" data-aos="fade-down">
        <img th:src="'data:image/jpeg;base64,' + ${profile.imagePrincipal64}"
             alt="Banner" id="imagemPrincipal"
             onerror="this.src='https://img.freepik.com/free-vector/smooth-white-wave-background_52683-55288.jpg?w=740';">
    </div>

    <div class="profile-card" data-aos="fade-up">
        <div class="text-center mb-4">
            <div class="avatar-container">
                <img  th:src="'data:image/jpeg;base64,' + ${profile.avatar64}"
                      class="rounded-circle shadow-lg"
                      style="width: 160px; height: 160px; object-fit: cover; border: 6px solid white;"
                      alt="Avatar"
                      onerror="this.src='https://img.freepik.com/free-vector/mysterious-mafia-man-smoking-cigarette_52683-34828.jpg?w=740';"
                >

                <div class="avatar-halo"></div>
                <button class="btn btn-light position-absolute bottom-0 end-0 translate-middle-x" data-bs-toggle="modal" data-bs-target="#editImageModal" title="Editar imagens">
                    <span class="material-symbols-rounded">edit</span>
                </button>
            </div>
            <h1 class="mt-3" style="font-family: 'Cinzel', serif; color: var(--brown);">
                <span th:text="${profile.nickname != null and profile.nickname != '' ? profile.nickname : user.username}">Seu Nome</span>
            </h1>
            <button class="btn btn-warning position-absolute top-0 end-0 m-3 shadow-lg"
                    onclick="alternarImagem()"
                    id="toggleImageBtn"
                    title="Recolher Banner"
                    style="z-index: 10;">
                <span class="material-symbols-rounded">expand_less</span>
            </button>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <p><strong>Versículo:</strong> <span th:text="${profile.versiculo != null ? profile.versiculo : 'Filipenses 4:13 - Tudo posso naquele que me fortalece.'}"></span></p>
                <p><strong>Igreja:</strong> <span th:text="${profile.igreja != null ? profile.igreja : 'Igreja Batista Central'}"></span></p>
                <p><strong>Ministério:</strong> <span th:text="${profile.ministerio != null ? profile.ministerio : 'Membro do Ministério de Jovens'}"></span></p>
            </div>
            <div class="col-md-6">
                <p><strong>Interesses:</strong> <span th:text="${profile.interesses != null ? profile.interesses : 'Estudos Bíblicos, Voluntariado, Música Gospel'}">—</span></p>
                <p><strong>Oração:</strong> <span th:text="${profile.oracao != null ? profile.oracao : 'Buscando sempre a orientação de Deus em cada passo da minha vida.'}"></span></p>
            </div>
        </div>

        <div class="text-center">
            <button class="btn btn-faith me-3" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <span class="material-symbols-rounded">edit</span> Editar Perfil
            </button>
        </div>
    </div>


    <div class="mt-5" data-aos="fade-up" data-aos-delay="200">
        <h2 class="text-center mb-5" style="font-family: 'Cinzel', serif; color: var(--brown);">Estatísticas da Fé</h2>
        <div class="row g-4 justify-content-center">
            <div class="col-6 col-md-4 col-lg-2">
                <div class="stat-card">
                    <p class="mb-1">Dias na Comunidade</p>
                    <div class="stat-number" th:text="${diasAcessados != null ? diasAcessados : 0}">0</div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
                <div class="stat-card">
                    <p class="mb-1">Quantidade de Postagens</p>
                    <div class="stat-number" th:text="${QTpostagens != null ? QTpostagens : 0}">0</div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
                <div class="stat-card">
                    <p class="mb-1">Leituras Em Andamento</p>
                    <div class="stat-number" th:text="${inProgressTasks != null ? inProgressTasks : 0}">0</div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
                <div class="stat-card">
                    <p class="mb-1">Versículos <br>Salvos<br> </p>
                    <div class="stat-number" th:text="${versiculosSalvos != null ? versiculosSalvos.size() : 0}">0</div>
                </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
                <div class="stat-card">
                    <p class="mb-1">Total <br>Atividades</br></p>
                    <div class="stat-number" th:text="${totalTasks != null ? totalTasks : 0}">0</div>
                </div>
            </div>
        </div>
    </div>


    <div class="mt-5" data-aos="fade-up" data-aos-delay="400">
        <h2 class="text-center mb-4" style="font-family: 'Cinzel', serif; color: var(--brown);">Progresso de Leitura</h2>

        <div th:if="${ultimasLeituras == null or #lists.isEmpty(ultimasLeituras)}" class="text-center p-5 bg-white rounded shadow">
            <p class="lead">Comece sua jornada na <a th:href="@{/biblia/biblioteca}" class="text-warning fw-bold">Biblioteca da Fé</a></p>
        </div>

        <div class="row g-4" th:if="${ultimasLeituras != null and !#lists.isEmpty(ultimasLeituras)}">
            <div class="col-12" th:each="leitura : ${ultimasLeituras}">
                <div class="reading-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="h5 mb-0" th:text="${leitura.livro != null ? leitura.livro.nome : '—'}">—</h3>
                        <span class="badge bg-warning text-dark">
                            Cap. <span th:text="${leitura.capituloAtual != null ? leitura.capituloAtual : 1}">1</span>
                            de <span th:text="${leitura.totalCapitulos != null ? leitura.totalCapitulos : 1}">1</span>
                        </span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar"
                             th:style="'width: ' + (${leitura.progressoPercentual != null ? leitura.progressoPercentual : 0}) + '%'"
                             th:text="${leitura.progressoPercentual != null ? leitura.progressoPercentual : 0} + '%'">
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <a th:if="${leitura.progressoPercentual == null or leitura.progressoPercentual < 100}"
                           th:href="@{'/biblia/leitura/' + ${leitura.livro.id} + '/' + ${leitura.capituloAtual}}"
                           class="btn btn-faith btn-sm">
                            Continuar Leitura
                        </a>
                        <span th:if="${leitura.progressoPercentual != null and leitura.progressoPercentual >= 100}" class="badge bg-success fs-6">Concluído</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/updateProfile}" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <div class="row g-3">

                        <div class="col-md-6">
                            <input type="text" class="form-control" name="nickname" placeholder="Nome ou Apelido"
                                   th:value="${profile.nickname != null ? profile.nickname : user.username}">
                        </div>


                        <div class="col-md-6">
                            <input type="text" class="form-control" name="versiculo" placeholder="Versículo Favorito"
                                   th:value="${profile.versiculo != null ? profile.versiculo : 'Filipenses 4:13'}">
                        </div>


                        <div class="col-md-6">
                            <input type="text" class="form-control" name="igreja" placeholder="Igreja"
                                   th:value="${profile.igreja != null ? profile.igreja : 'Igreja Batista Central'}">
                        </div>


                        <div class="col-md-6">
                            <input type="text" class="form-control" name="ministerio" placeholder="Ministério"
                                   th:value="${profile.ministerio != null ? profile.ministerio : 'Membro do Ministério de Jovens'}">
                        </div>


                        <div class="col-12">
                            <input type="text" class="form-control" name="interesses" placeholder="Interesses"
                                   th:value="${profile.interesses != null ? profile.interesses : 'Estudos Bíblicos, Voluntariado, Música Gospel'}">
                        </div>


                        <div class="col-12">
            <textarea class="form-control" name="oracao" rows="3" placeholder="Oração"
                      th:text="${profile.oracao != null ? profile.oracao : 'Buscando sempre a orientação de Deus em cada passo da minha vida.'}"></textarea>
                        </div>
                    </div>


                    <button type="submit" class="btn btn-faith w-100 mt-4">Salvar</button>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editImageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Atualizar Imagens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/profile/updateProfile}" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <div class="mb-3">
                        <label>Foto de Perfil</label>
                        <input type="file" class="form-control" name="avatarFile" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label>Imagem Principal</label>
                        <input type="file" class="form-control" name="imagePrincipalFile" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-faith w-100">Atualizar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>“Porque para mim o viver é Cristo, e o morrer é ganho.” (Filipenses 1:21)</p>
</footer>

<form id="logoutForm" th:action="@{/logout}" method="post" style="display:none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<script th:src="@{/js/profile.js}"></script>
</body>
</html>